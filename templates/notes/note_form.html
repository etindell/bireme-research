{% extends "base.html" %}

{% block title %}{% if object %}Edit Note{% else %}Add Note{% endif %} - Bireme Research{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl">
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">
                {% if object %}Edit Note{% else %}Add Note{% endif %}
            </h1>
        </div>
    </div>

    <form method="post" class="space-y-8">
        {% csrf_token %}

        <div class="bg-white shadow rounded-lg p-6 space-y-6">
            <!-- Company -->
            <div>
                <label for="id_company" class="block text-sm font-medium leading-6 text-gray-900">
                    Company *
                </label>
                <div class="mt-2">
                    {{ form.company }}
                </div>
                {% if form.company.errors %}
                <p class="mt-2 text-sm text-red-600">{{ form.company.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Title -->
            <div>
                <label for="id_title" class="block text-sm font-medium leading-6 text-gray-900">
                    Title *
                </label>
                <p class="text-xs text-gray-500 mb-2">This is the "bullet point" that's always visible.</p>
                <div class="mt-2">
                    {{ form.title }}
                </div>
                {% if form.title.errors %}
                <p class="mt-2 text-sm text-red-600">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Content -->
            <div>
                <label for="id_content" class="block text-sm font-medium leading-6 text-gray-900">
                    Details
                </label>
                <p class="text-xs text-gray-500 mb-2">
                    Expanded content shown when the note is clicked.
                    <span class="text-primary-600">You can paste images directly!</span>
                </p>

                <!-- Formatting Toolbar -->
                <div class="mt-2 mb-1 flex items-center gap-1 border border-gray-300 border-b-0 rounded-t-md bg-gray-50 px-2 py-1.5">
                    <button type="button" onclick="formatText('bold')" title="Bold (Ctrl+B)"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="formatText('italic')" title="Italic (Ctrl+I)"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 4h4m-2 0l-4 16m0 0h4"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="formatText('underline')" title="Underline (Ctrl+U)"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v7a5 5 0 0010 0V4M5 20h14"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="formatText('strikethrough')" title="Strikethrough"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v6m0 4v6M4 12h16"></path>
                        </svg>
                    </button>
                    <div class="w-px h-5 bg-gray-300 mx-1"></div>
                    <button type="button" onclick="formatText('bullet')" title="Bullet List"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h.01M8 6h12M4 12h.01M8 12h12M4 18h.01M8 18h12"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="formatText('number')" title="Numbered List"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <text x="2" y="8" font-size="7" font-weight="bold">1.</text>
                            <text x="2" y="15" font-size="7" font-weight="bold">2.</text>
                            <text x="2" y="22" font-size="7" font-weight="bold">3.</text>
                            <line x1="11" y1="5" x2="22" y2="5" stroke="currentColor" stroke-width="2"/>
                            <line x1="11" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2"/>
                            <line x1="11" y1="19" x2="22" y2="19" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    <div class="w-px h-5 bg-gray-300 mx-1"></div>
                    <button type="button" onclick="formatText('link')" title="Insert Link"
                            class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </button>
                    <span class="ml-auto text-xs text-gray-400">Formatting supported</span>
                </div>

                <div class="relative">
                    {{ form.content }}
                    <div id="upload-indicator" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center rounded-md">
                        <div class="flex items-center gap-2 text-gray-600">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Uploading image...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <!-- Note Type -->
                <div>
                    <label for="id_note_type" class="block text-sm font-medium leading-6 text-gray-900">
                        Type
                    </label>
                    <div class="mt-2">
                        {{ form.note_type }}
                    </div>
                </div>

                <!-- Note Date -->
                <div>
                    <label for="id_note_date" class="block text-sm font-medium leading-6 text-gray-900">
                        Date
                    </label>
                    <p class="text-xs text-gray-500 mb-2">Date of the event (e.g., earnings call).</p>
                    <div class="mt-2">
                        {{ form.note_date }}
                    </div>
                </div>
            </div>

            <!-- Referenced Companies -->
            <div>
                <label for="id_referenced_companies" class="block text-sm font-medium leading-6 text-gray-900">
                    Also Tag
                </label>
                <p class="text-xs text-gray-500 mb-2">Other companies mentioned in this note.</p>
                <div class="mt-2">
                    {{ form.referenced_companies }}
                </div>
                <p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple.</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-x-3">
            <a href="{% if object %}{{ object.get_absolute_url }}{% else %}{% url 'notes:list' %}{% endif %}"
               class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit"
                    class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                {% if object %}Save Changes{% else %}Create Note{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Formatting toolbar functionality
function formatText(type) {
    const textarea = document.getElementById('id_content');
    if (!textarea) return;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    let before = '';
    let after = '';
    let insert = '';
    let cursorOffset = 0;

    switch (type) {
        case 'bold':
            before = '**';
            after = '**';
            insert = selectedText || 'bold text';
            cursorOffset = selectedText ? 0 : 2;
            break;
        case 'italic':
            before = '*';
            after = '*';
            insert = selectedText || 'italic text';
            cursorOffset = selectedText ? 0 : 1;
            break;
        case 'underline':
            before = '++';
            after = '++';
            insert = selectedText || 'underlined text';
            cursorOffset = selectedText ? 0 : 2;
            break;
        case 'strikethrough':
            before = '~~';
            after = '~~';
            insert = selectedText || 'strikethrough text';
            cursorOffset = selectedText ? 0 : 2;
            break;
        case 'bullet':
            // Add bullet at line start
            const lineStart = text.lastIndexOf('\n', start - 1) + 1;
            const prefix = text.substring(0, lineStart);
            const suffix = text.substring(lineStart);
            textarea.value = prefix + '- ' + suffix;
            textarea.setSelectionRange(lineStart + 2, lineStart + 2);
            textarea.focus();
            return;
        case 'number':
            // Add number at line start
            const nLineStart = text.lastIndexOf('\n', start - 1) + 1;
            const nPrefix = text.substring(0, nLineStart);
            const nSuffix = text.substring(nLineStart);
            textarea.value = nPrefix + '1. ' + nSuffix;
            textarea.setSelectionRange(nLineStart + 3, nLineStart + 3);
            textarea.focus();
            return;
        case 'link':
            const url = prompt('Enter URL:');
            if (!url) return;
            before = '[';
            after = '](' + url + ')';
            insert = selectedText || 'link text';
            cursorOffset = selectedText ? 0 : 1;
            break;
        default:
            return;
    }

    const newText = text.substring(0, start) + before + insert + after + text.substring(end);
    textarea.value = newText;

    // Set cursor position
    if (selectedText) {
        textarea.setSelectionRange(start + before.length, start + before.length + insert.length);
    } else {
        const newCursor = start + before.length + cursorOffset;
        textarea.setSelectionRange(newCursor, newCursor + insert.length - cursorOffset * 2);
    }
    textarea.focus();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    const textarea = document.getElementById('id_content');
    if (!textarea || document.activeElement !== textarea) return;

    if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                formatText('bold');
                break;
            case 'i':
                e.preventDefault();
                formatText('italic');
                break;
            case 'u':
                e.preventDefault();
                formatText('underline');
                break;
        }
    }
});

(function initImageUpload() {
    const contentTextarea = document.getElementById('id_content');
    const uploadIndicator = document.getElementById('upload-indicator');

    if (!contentTextarea || contentTextarea.dataset.imageUploadInit) return;

    // Mark as initialized to prevent duplicate listeners
    contentTextarea.dataset.imageUploadInit = 'true';

    // Handle paste events
    contentTextarea.addEventListener('paste', async function(e) {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (const item of items) {
            if (item.type.startsWith('image/')) {
                e.preventDefault();

                const file = item.getAsFile();
                if (!file) continue;

                await uploadImage(file);
                break;
            }
        }
    });

    // Handle drag and drop
    contentTextarea.addEventListener('dragover', function(e) {
        e.preventDefault();
        contentTextarea.classList.add('ring-2', 'ring-primary-500');
    });

    contentTextarea.addEventListener('dragleave', function(e) {
        contentTextarea.classList.remove('ring-2', 'ring-primary-500');
    });

    contentTextarea.addEventListener('drop', async function(e) {
        e.preventDefault();
        contentTextarea.classList.remove('ring-2', 'ring-primary-500');

        const files = e.dataTransfer?.files;
        if (!files) return;

        for (const file of files) {
            if (file.type.startsWith('image/')) {
                await uploadImage(file);
            }
        }
    });

    async function uploadImage(file) {
        uploadIndicator.classList.remove('hidden');

        try {
            const formData = new FormData();
            formData.append('image', file);

            // Get fresh CSRF token from cookie
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
                || '{{ csrf_token }}';

            const response = await fetch('{% url "notes:upload_image" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Insert markdown at cursor position
                const cursorPos = contentTextarea.selectionStart;
                const textBefore = contentTextarea.value.substring(0, cursorPos);
                const textAfter = contentTextarea.value.substring(cursorPos);

                // Add newlines if needed
                const prefix = textBefore.length > 0 && !textBefore.endsWith('\n') ? '\n' : '';
                const suffix = textAfter.length > 0 && !textAfter.startsWith('\n') ? '\n' : '';

                contentTextarea.value = textBefore + prefix + data.markdown + suffix + textAfter;

                // Move cursor after the inserted text
                const newPos = cursorPos + prefix.length + data.markdown.length + suffix.length;
                contentTextarea.setSelectionRange(newPos, newPos);
                contentTextarea.focus();

                // Show success toast
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: { message: 'Image uploaded!', type: 'success' }
                }));
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            console.error('Upload error:', error);
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message: error.message || 'Failed to upload image', type: 'error' }
            }));
        } finally {
            uploadIndicator.classList.add('hidden');
        }
    }
})();
</script>
{% endblock %}
