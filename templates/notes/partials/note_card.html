{% load markdown_extras %}
<!-- Note card with collapsible content -->
<div class="note-card border-l-4 bg-white"
     style="border-color: {{ note.note_type.color|default:'#9CA3AF' }}"
     x-data="{ expanded: {% if not note.is_collapsed %}true{% else %}false{% endif %} }"
     :class="{ 'ring-2 ring-primary-500 bg-primary-50': {% if selectable %}selectMode && isSelected({{ note.pk }}){% else %}false{% endif %} }"
     id="note-{{ note.pk }}">

    <!-- Collapsed view (always visible) -->
    <div class="px-4 py-3 flex items-start gap-3 cursor-pointer hover:bg-gray-50"
         @click="{% if selectable %}selectMode ? toggleNote({{ note.pk }}) : {% endif %}expanded = !expanded">

        {% if selectable %}
        <!-- Checkbox (shown in select mode) -->
        <div x-show="selectMode" x-cloak class="flex-shrink-0 mt-0.5" @click.stop="toggleNote({{ note.pk }})">
            <div class="h-5 w-5 rounded border-2 flex items-center justify-center transition-colors"
                 :class="isSelected({{ note.pk }}) ? 'bg-primary-600 border-primary-600' : 'border-gray-300 bg-white'">
                <svg x-show="isSelected({{ note.pk }})" class="h-3 w-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
            </div>
        </div>
        {% endif %}

        <!-- Expand icon -->
        <span class="text-gray-400 mt-0.5 flex-shrink-0" {% if selectable %}x-show="!selectMode"{% endif %}>
            <svg x-show="!expanded" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"/>
            </svg>
            <svg x-show="expanded" x-cloak class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
        </span>

        <!-- Title and metadata -->
        <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
                {% if note.is_pinned %}
                <svg class="h-4 w-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z"/>
                </svg>
                {% endif %}
                <span class="text-sm text-gray-900 font-medium">{{ note.title }}</span>
            </div>

            <div class="flex items-center gap-2 mt-1 text-xs text-gray-500 flex-wrap">
                {% if note.note_type %}
                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                      style="background-color: {{ note.note_type.color }}20; color: {{ note.note_type.color }}">
                    {{ note.note_type.name }}
                </span>
                {% endif %}

                {% with note.cash_flow as cash_flow %}
                {% if cash_flow %}
                <span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700" title="Has IRR cash flow assumptions">
                    IRR: {{ cash_flow.calculated_irr|floatformat:1 }}%
                </span>
                {% endif %}
                {% endwith %}

                {% if show_company and note.company %}
                <a href="{{ note.company.get_absolute_url }}"
                   class="text-primary-600 hover:underline"
                   @click.stop>
                    {{ note.company.name }}
                </a>
                {% elif show_company and not note.company %}
                <span class="text-gray-400 italic">General</span>
                {% endif %}

                <span>{{ note.display_date|date:"M j, Y" }}</span>

                {% if note.created_by %}
                <span>{{ note.created_by.get_short_name }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Expanded content -->
    <div x-show="expanded"
         x-cloak
         x-collapse
         class="px-4 pb-4 pl-11 border-t border-gray-100">

        {% if note.content %}
        <div class="prose prose-sm max-w-none text-gray-700 mt-3">
            {{ note.content|markdown }}
        </div>
        {% endif %}

        {% if note.referenced_companies.exists %}
        <div class="mt-3 pt-3 border-t border-gray-100">
            <span class="text-xs text-gray-500">Also tagged:</span>
            {% for company in note.referenced_companies.all %}
            <a href="{{ company.get_absolute_url }}"
               class="text-xs text-primary-600 hover:underline ml-1">
                {{ company.name }}{% if not forloop.last %},{% endif %}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="mt-3 pt-3 border-t border-gray-100 flex items-center gap-4">
            <a href="{% url 'notes:update' note.pk %}"
               hx-boost="false"
               class="text-xs text-gray-500 hover:text-gray-700">
                Edit
            </a>
            <button hx-post="{% url 'notes:toggle_pin' note.pk %}"
                    hx-swap="none"
                    class="text-xs text-gray-500 hover:text-gray-700">
                {% if note.is_pinned %}Unpin{% else %}Pin{% endif %}
            </button>
            <button hx-delete="{% url 'notes:delete' note.pk %}"
                    hx-confirm="Delete this note?"
                    hx-target="#note-{{ note.pk }}"
                    hx-swap="outerHTML"
                    class="text-xs text-red-500 hover:text-red-700">
                Delete
            </button>
        </div>
    </div>
</div>
