{% extends "base.html" %}

{% block title %}News - Bireme Research{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">
                News
            </h1>
            <p class="mt-1 text-sm text-gray-500">
                {% if unread_count > 0 %}
                {{ unread_count }} unread item{{ unread_count|pluralize }}
                {% else %}
                All caught up
                {% endif %}
            </p>
        </div>
        <div class="mt-4 flex gap-x-3 md:ml-4 md:mt-0">
            <form hx-post="{% url 'news:fetch_all' %}"
                  hx-swap="none"
                  hx-indicator="#fetch-indicator"
                  x-data="{ fetching: false }"
                  @htmx:before-request.camel="fetching = true"
                  @htmx:after-request.camel="fetching = true; setTimeout(() => window.location.reload(), 500)">
                {% csrf_token %}
                <button type="submit"
                        :disabled="fetching"
                        :class="fetching ? 'opacity-75 cursor-not-allowed' : 'hover:bg-primary-500'"
                        class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm">
                    <!-- Normal icon -->
                    <svg x-show="!fetching" class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    <!-- Spinning icon -->
                    <svg x-show="fetching" x-cloak class="-ml-0.5 mr-1.5 h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="fetching ? 'Fetching news...' : 'Fetch News'">Fetch News</span>
                </button>
            </form>
            <a href="{% url 'news:manage_blacklist' %}"
               class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Blocked Sources
            </a>
            <form hx-post="{% url 'news:clear_all' %}" hx-swap="none"
                  hx-confirm="Delete ALL news items? This cannot be undone.">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-red-600 shadow-sm ring-1 ring-inset ring-red-300 hover:bg-red-50">
                    <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                    Clear All News
                </button>
            </form>
            {% if unread_count > 0 %}
            <form hx-post="{% url 'news:mark_all_read' %}" hx-swap="none">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Mark All Read
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Description -->
    <div class="rounded-lg bg-gray-50 ring-1 ring-gray-200 px-4 py-3">
        <p class="text-sm text-gray-600">
            News is sourced from Google News RSS, Tavily web search, and SEC EDGAR filings, then filtered for relevance and classified by importance using Google Gemini. Only material events like earnings, M&A, executive changes, and regulatory actions are surfaced â€” routine mentions and stock quote pages are automatically removed.
        </p>
    </div>

    <!-- Preference Profile -->
    {% if preference_profile %}
    <div x-data="{ open: false }" class="rounded-lg bg-indigo-50 ring-1 ring-indigo-200 px-4 py-3">
        <button @click="open = !open" class="flex w-full items-center justify-between text-sm font-medium text-indigo-700">
            <span class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                </svg>
                Your News Preference Profile
            </span>
            <svg :class="open && 'rotate-180'" class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
        </button>
        <div x-show="open" x-cloak class="mt-2 text-sm text-indigo-600">
            <p>{{ preference_profile }}</p>
            <p class="mt-2 text-xs text-indigo-400">Generated from your thumbs up/down feedback. Used to calibrate AI news importance ratings.</p>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-4">
        <form method="get" class="flex flex-wrap gap-4 items-end">
            <!-- Company filter -->
            <div class="flex-1 min-w-[200px]">
                <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                <select id="company" name="company"
                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                    <option value="{{ company.slug }}" {% if current_company == company.slug %}selected{% endif %}>
                        {{ company.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Importance filter -->
            <div class="w-40">
                <label for="importance" class="block text-sm font-medium text-gray-700 mb-1">Importance</label>
                <select id="importance" name="importance"
                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm">
                    <option value="">All</option>
                    <option value="high" {% if current_importance == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if current_importance == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if current_importance == 'low' %}selected{% endif %}>Low</option>
                </select>
            </div>

            <!-- Source filter -->
            <div class="w-40">
                <label for="source" class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                <select id="source" name="source"
                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm">
                    <option value="">All Sources</option>
                    <option value="web" {% if current_source == 'web' %}selected{% endif %}>Web Search</option>
                    <option value="sec_edgar" {% if current_source == 'sec_edgar' %}selected{% endif %}>SEC EDGAR</option>
                </select>
            </div>

            <!-- Checkboxes -->
            <div class="flex items-center gap-4">
                <label class="flex items-center">
                    <input type="checkbox" name="unread" value="1" {% if show_unread %}checked{% endif %}
                           class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                    <span class="ml-2 text-sm text-gray-700">Unread only</span>
                </label>
            </div>

            <!-- Submit -->
            <button type="submit"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                Filter
            </button>

            {% if current_company or current_importance or current_source or show_unread %}
            <a href="{% url 'news:dashboard' %}"
               class="text-sm text-gray-500 hover:text-gray-700">
                Clear filters
            </a>
            {% endif %}
        </form>
    </div>

    <!-- News list -->
    <div id="news-list" class="relative">
        {% include "news/partials/news_list.html" %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Show a loading overlay on the news list while fetching
document.body.addEventListener('htmx:beforeRequest', function(e) {
    if (e.detail.elt.closest('form[hx-post*="fetch-all"]')) {
        var list = document.getElementById('news-list');
        if (!list) return;
        var overlay = document.createElement('div');
        overlay.id = 'fetch-overlay';
        overlay.className = 'absolute inset-0 bg-white/70 flex flex-col items-center justify-center rounded-lg z-10';
        overlay.style.minHeight = '200px';
        overlay.innerHTML = '<svg class="animate-spin h-8 w-8 text-primary-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-sm font-medium text-gray-600">Searching Google News, SEC EDGAR & Tavily...</p><p class="text-xs text-gray-400 mt-1">Classifying results with Gemini AI</p>';
        list.style.position = 'relative';
        list.appendChild(overlay);
    }
});
</script>
{% endblock %}
