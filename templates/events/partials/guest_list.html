<div id="guest-list-section" class="space-y-4">
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">
                Guests
                {% if guests %}
                <span class="text-sm font-normal text-gray-500">({{ guests|length }})</span>
                {% endif %}
            </h2>
            <div class="flex items-center gap-x-2">
                {% if guests %}
                <button hx-post="{% url 'events:generate_emails' event.pk %}"
                        hx-target="#guest-list-section"
                        hx-swap="outerHTML"
                        class="inline-flex items-center gap-x-1.5 rounded-md bg-white px-2.5 py-1.5 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                    </svg>
                    Generate Emails
                    <span class="htmx-indicator">
                        <svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </span>
                </button>
                <button hx-post="{% url 'events:send_emails' event.pk %}"
                        hx-target="#guest-list-section"
                        hx-swap="outerHTML"
                        hx-confirm="Send invitation emails to all guests with generated emails?"
                        class="inline-flex items-center gap-x-1.5 rounded-md bg-primary-600 px-2.5 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-primary-500">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                    </svg>
                    Send Emails
                </button>
                {% endif %}
            </div>
        </div>

        {% if guests %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% if event.event_type == 'poll' %}Status{% else %}RSVP{% endif %}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invite</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RSVP Link</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for guest in guests %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ guest.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ guest.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if event.event_type == 'poll' %}
                            {% if guest.rsvp_responded_at %}
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Responded</span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700 ring-1 ring-inset ring-yellow-600/20">Pending</span>
                            {% endif %}
                        {% else %}
                            {% if guest.rsvp_status == 'yes' %}
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Yes</span>
                            {% elif guest.rsvp_status == 'no' %}
                            <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/20">No</span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700 ring-1 ring-inset ring-yellow-600/20">Pending</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if guest.email_sent %}
                        <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Sent</span>
                        {% elif guest.generated_email %}
                        <button hx-get="{% url 'events:preview_email' event.pk guest.pk %}"
                                hx-target="#email-preview-modal"
                                hx-swap="innerHTML"
                                class="text-xs text-primary-600 hover:text-primary-800 underline">Preview</button>
                        {% else %}
                        <span class="text-xs text-gray-400">Not generated</span>
                        {% endif %}
                        {% if guest.generated_email %}
                        <button hx-post="{% url 'events:send_test_email' event.pk guest.pk %}"
                                hx-target="#guest-list-section"
                                hx-swap="outerHTML"
                                class="ml-2 text-xs text-amber-600 hover:text-amber-800 underline">Send Test</button>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="navigator.clipboard.writeText('{% if SITE_URL %}{{ SITE_URL }}{% else %}' + window.location.origin + '{% endif %}{% url 'events:rsvp_public' guest.rsvp_token %}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Link', 2000)"
                                class="text-xs text-primary-600 hover:text-primary-800 underline">Copy Link</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button hx-post="{% url 'events:remove_guest' event.pk guest.pk %}"
                                hx-target="#guest-list-section"
                                hx-swap="outerHTML"
                                hx-confirm="Remove {{ guest.name }}?"
                                class="text-xs text-red-600 hover:text-red-800">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="px-6 py-8 text-center text-sm text-gray-500">
            No guests yet. Upload a screenshot or add guests manually below.
        </div>
        {% endif %}
    </div>

    <!-- Add Guest Form -->
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-lg p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Add Guest Manually</h3>
        <form hx-post="{% url 'events:add_guest' event.pk %}"
              hx-target="#guest-list-section"
              hx-swap="outerHTML"
              class="flex items-end gap-x-3">
            {% csrf_token %}
            <div class="flex-1">
                <label for="id_name" class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                {{ guest_form.name }}
            </div>
            <div class="flex-1">
                <label for="id_email" class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                {{ guest_form.email }}
            </div>
            <button type="submit"
                    class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Add
            </button>
        </form>
    </div>

    <!-- Email Preview Modal -->
    <div id="email-preview-modal"></div>
</div>
