{% extends "base.html" %}

{% block title %}{% if object %}Update Forecast{% else %}Add Forecast{% endif %} - {{ company.name }} - Bireme Research{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl">
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <nav class="flex mb-2" aria-label="Breadcrumb">
                <ol role="list" class="flex items-center space-x-2 text-sm text-gray-500">
                    <li><a href="{% url 'companies:list' %}" class="hover:text-gray-700">Companies</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li><a href="{{ company.get_absolute_url }}" class="hover:text-gray-700">{{ company.name }}</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li>Valuation</li>
                </ol>
            </nav>
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">
                {% if object %}Update Forecast{% else %}New Forecast{% endif %}
            </h1>
            <p class="mt-1 text-sm text-gray-500">{{ company.name }}</p>
            {% if object %}
            <p class="mt-2 text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded inline-block">
                Saving will create a new forecast. The current forecast will be preserved in history.
            </p>
            {% endif %}
        </div>
    </div>

    <form method="post" class="space-y-8">
        {% csrf_token %}

        <!-- Current Price Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div id="price-display">
                    <h3 class="text-sm font-medium text-blue-800">Current Stock Price</h3>
                    {% if object and object.current_price %}
                    <p class="text-2xl font-bold text-blue-900">${{ object.current_price|floatformat:2 }}</p>
                    <p class="text-xs text-blue-600">
                        Last updated: {{ object.price_last_updated|date:"M d, Y H:i" }}
                    </p>
                    {% else %}
                    <p class="text-sm text-blue-700">Price will be fetched from Yahoo Finance when saved.</p>
                    {% endif %}
                </div>
                {% if object %}
                <button type="button"
                        hx-post="{% url 'companies:refresh_price' object.pk %}"
                        hx-target="#price-display"
                        hx-swap="innerHTML"
                        hx-indicator="#price-refresh-indicator"
                        class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50">
                    <svg id="price-refresh-indicator" class="htmx-indicator animate-spin -ml-0.5 mr-1.5 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg class="-ml-0.5 mr-1.5 h-4 w-4 htmx-indicator-inverse" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    <span class="htmx-indicator">Fetching...</span>
                    <span class="htmx-indicator-inverse">Refresh Price</span>
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Share Data -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Share Data</h2>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="id_shares_outstanding" class="block text-sm font-medium leading-6 text-gray-900">
                        Shares Outstanding (millions) *
                    </label>
                    <div class="mt-2">{{ form.shares_outstanding }}</div>
                    {% if form.shares_outstanding.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.shares_outstanding.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_price_override" class="block text-sm font-medium leading-6 text-gray-900">
                        Price Override
                    </label>
                    <div class="mt-2">{{ form.price_override }}</div>
                    <p class="mt-1 text-xs text-gray-500">Leave blank to use Yahoo Finance price</p>
                </div>
            </div>
        </div>

        <!-- FCF Forecasts -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">FCF Per Share Forecasts</h2>
            <p class="text-sm text-gray-500 mb-4">Enter your projected free cash flow per share for each year.</p>
            <div class="grid grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium leading-6 text-gray-900">Year 1 *</label>
                    <div class="mt-2">{{ form.fcf_year_1 }}</div>
                    {% if form.fcf_year_1.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.fcf_year_1.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium leading-6 text-gray-900">Year 2 *</label>
                    <div class="mt-2">{{ form.fcf_year_2 }}</div>
                    {% if form.fcf_year_2.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.fcf_year_2.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium leading-6 text-gray-900">Year 3 *</label>
                    <div class="mt-2">{{ form.fcf_year_3 }}</div>
                    {% if form.fcf_year_3.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.fcf_year_3.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium leading-6 text-gray-900">Year 4 *</label>
                    <div class="mt-2">{{ form.fcf_year_4 }}</div>
                    {% if form.fcf_year_4.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.fcf_year_4.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium leading-6 text-gray-900">Year 5 *</label>
                    <div class="mt-2">{{ form.fcf_year_5 }}</div>
                    {% if form.fcf_year_5.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.fcf_year_5.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Terminal Value -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Terminal Value</h2>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="id_terminal_value" class="block text-sm font-medium leading-6 text-gray-900">
                        Terminal Value Per Share *
                    </label>
                    <div class="mt-2">{{ form.terminal_value }}</div>
                    <p class="mt-1 text-xs text-gray-500">Value at end of Year 5 (sale price or perpetuity value)</p>
                    {% if form.terminal_value.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.terminal_value.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="id_as_of_date" class="block text-sm font-medium leading-6 text-gray-900">
                        As of Date *
                    </label>
                    <div class="mt-2">{{ form.as_of_date }}</div>
                    {% if form.as_of_date.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.as_of_date.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Revenue Projections (Optional) -->
        <div class="bg-white shadow rounded-lg p-6" x-data="{ showRevenue: {% if form.revenue_year_1.value or form.revenue_year_2.value or form.revenue_year_3.value or form.revenue_year_4.value or form.revenue_year_5.value %}true{% else %}false{% endif %} }">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-medium text-gray-900">Revenue Projections</h2>
                    <p class="text-sm text-gray-500">Optional forecasts for tracking</p>
                </div>
                <button type="button" @click="showRevenue = !showRevenue"
                        class="text-sm font-medium text-primary-600 hover:text-primary-500">
                    <span x-text="showRevenue ? 'Hide' : 'Show'"></span>
                </button>
            </div>
            <div x-show="showRevenue" x-cloak>
                <div class="grid grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 1</label>
                        <div class="mt-2">{{ form.revenue_year_1 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 2</label>
                        <div class="mt-2">{{ form.revenue_year_2 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 3</label>
                        <div class="mt-2">{{ form.revenue_year_3 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 4</label>
                        <div class="mt-2">{{ form.revenue_year_4 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 5</label>
                        <div class="mt-2">{{ form.revenue_year_5 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profitability Metric Projections (Optional) -->
        <div class="bg-white shadow rounded-lg p-6" x-data="{ showProfitability: {% if form.ebit_ebitda_year_1.value or form.ebit_ebitda_year_2.value or form.ebit_ebitda_year_3.value or form.ebit_ebitda_year_4.value or form.ebit_ebitda_year_5.value %}true{% else %}false{% endif %} }">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-medium text-gray-900">
                        {% if company.profitability_metric %}{{ company.profitability_metric }}{% else %}Profitability Metric{% endif %} Projections
                    </h2>
                    <p class="text-sm text-gray-500">Optional forecasts for tracking</p>
                </div>
                <button type="button" @click="showProfitability = !showProfitability"
                        class="text-sm font-medium text-primary-600 hover:text-primary-500">
                    <span x-text="showProfitability ? 'Hide' : 'Show'"></span>
                </button>
            </div>
            <div x-show="showProfitability" x-cloak>
                <div class="grid grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 1</label>
                        <div class="mt-2">{{ form.ebit_ebitda_year_1 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 2</label>
                        <div class="mt-2">{{ form.ebit_ebitda_year_2 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 3</label>
                        <div class="mt-2">{{ form.ebit_ebitda_year_3 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 4</label>
                        <div class="mt-2">{{ form.ebit_ebitda_year_4 }}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium leading-6 text-gray-900">Year 5</label>
                        <div class="mt-2">{{ form.ebit_ebitda_year_5 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes & Status -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Notes & Status</h2>
            <div class="space-y-4">
                <div>
                    <label for="id_notes" class="block text-sm font-medium leading-6 text-gray-900">Notes</label>
                    <div class="mt-2">{{ form.notes }}</div>
                    <p class="mt-1 text-xs text-gray-500">Document your assumptions, scenarios, or key drivers.</p>
                </div>
                <div class="flex items-center">
                    {{ form.is_active }}
                    <label for="id_is_active" class="ml-2 text-sm text-gray-700">
                        Active valuation (use for IRR calculations and leaderboard)
                    </label>
                </div>
            </div>
        </div>

        <!-- Calculated IRR Preview -->
        {% if object and object.calculated_irr %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="text-sm font-medium text-green-800">Calculated IRR</h3>
            <p class="text-3xl font-bold {% if object.calculated_irr >= 15 %}text-green-700{% elif object.calculated_irr >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {{ object.calculated_irr|floatformat:1 }}%
            </p>
            <p class="text-xs text-green-600 mt-1">
                Last calculated: {{ object.irr_last_calculated|date:"M d, Y H:i" }}
            </p>
        </div>
        {% endif %}

        <!-- Forecast History -->
        {% if valuation_history %}
        <div class="bg-white shadow rounded-lg overflow-hidden" x-data="{ showHistory: false }">
            <button type="button"
                    @click="showHistory = !showHistory"
                    class="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="text-lg font-medium text-gray-900">Forecast History</h2>
                    <span class="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">
                        {{ valuation_history|length }}
                    </span>
                </div>
                <svg class="h-5 w-5 text-gray-400 transition-transform" :class="{ 'rotate-180': showHistory }" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>
            <div x-show="showHistory" x-collapse>
                <div class="border-t border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Y1</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Y2</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Y3</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Y4</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Y5</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">TV</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Price</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">IRR</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for history in valuation_history %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm text-gray-900 whitespace-nowrap">
                                        {{ history.created_at|date:"M d, Y" }}
                                        <div class="text-xs text-gray-500">{{ history.created_at|time:"H:i" }}</div>
                                    </td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.fcf_year_1|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.fcf_year_2|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.fcf_year_3|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.fcf_year_4|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.fcf_year_5|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">{{ history.terminal_value|floatformat:2 }}</td>
                                    <td class="px-4 py-2 text-sm text-right text-gray-600 font-mono">
                                        {% if history.current_price %}${{ history.current_price|floatformat:2 }}{% else %}-{% endif %}
                                    </td>
                                    <td class="px-4 py-2 text-sm text-right font-medium {% if history.calculated_irr >= 15 %}text-green-600{% elif history.calculated_irr >= 0 %}text-gray-900{% else %}text-red-600{% endif %}">
                                        {% if history.calculated_irr %}{{ history.calculated_irr|floatformat:1 }}%{% else %}-{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="flex justify-end gap-x-3">
            <a href="{{ company.get_absolute_url }}"
               class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit"
                    class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                {% if object %}Save New Forecast{% else %}Create Forecast{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}
