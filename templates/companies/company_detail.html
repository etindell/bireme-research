{% extends "base.html" %}

{% block title %}{{ company.name }} - Bireme Research{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-start md:justify-between">
        <div class="min-w-0 flex-1">
            <div class="flex items-center gap-x-3">
                <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">
                    {{ company.name }}
                </h1>
                <!-- Status dropdown -->
                <div x-data="{ open: false }" class="relative">
                    <button @click="open = !open"
                            type="button"
                            class="inline-flex items-center gap-x-1">
                        {% include "companies/partials/status_badge.html" with status=company.status %}
                        <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div x-show="open"
                         x-cloak
                         @click.away="open = false"
                         class="absolute left-0 z-10 mt-2 w-40 origin-top-left rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5">
                        <div class="py-1">
                            {% for value, label in statuses %}
                            <form hx-post="{% url 'companies:status_update' company.slug %}"
                                  hx-swap="none"
                                  @htmx:after-request="open = false; window.location.reload()">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="{{ value }}">
                                <button type="submit"
                                        class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 {% if company.status == value %}bg-gray-50{% endif %}">
                                    {{ label }}
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-1 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-gray-500">
                {% for ticker in company.tickers.all %}
                <span class="font-mono bg-gray-100 px-2 py-0.5 rounded">{{ ticker }}</span>
                {% endfor %}
                {% if company.sector %}
                <span>{{ company.get_sector_display }}</span>
                {% endif %}
                {% if company.country %}
                <span>{{ company.country }}</span>
                {% endif %}
                {% if company.website %}
                <a href="{{ company.website }}" target="_blank" class="text-primary-600 hover:text-primary-500">
                    Website
                    <svg class="inline h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                    </svg>
                </a>
                {% endif %}
            </div>
        </div>
        <div class="mt-4 flex flex-shrink-0 gap-x-2 md:ml-4 md:mt-0">
            <a href="{% url 'notes:create' %}?company={{ company.slug }}"
               class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Note
            </a>
            <a href="{% url 'companies:update' company.slug %}"
               class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Edit
            </a>
            <a href="{% url 'export:company_pdf' company.slug %}"
               class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
                </svg>
                Export PDF
            </a>
        </div>
    </div>

    <!-- Description -->
    {% if company.description %}
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Description</h3>
        <p class="text-gray-700 whitespace-pre-wrap">{{ company.description }}</p>
    </div>
    {% endif %}

    <!-- Investment Thesis -->
    {% if company.thesis %}
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Investment Thesis</h3>
        <p class="text-gray-700 whitespace-pre-wrap">{{ company.thesis }}</p>
    </div>
    {% endif %}

    <!-- Valuation -->
    {% with valuation=company.get_active_valuation %}
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-medium text-gray-500">Valuation</h3>
            {% if valuation %}
            <a href="{% url 'companies:valuation_update' company.slug valuation.pk %}"
               class="text-sm font-medium text-primary-600 hover:text-primary-500">
                Edit valuation
            </a>
            {% else %}
            <a href="{% url 'companies:valuation_create' company.slug %}"
               class="text-sm font-medium text-primary-600 hover:text-primary-500">
                Add valuation
            </a>
            {% endif %}
        </div>

        {% if valuation %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- IRR -->
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">IRR</p>
                <p class="mt-1 text-2xl font-bold {% if valuation.calculated_irr >= 15 %}text-green-600{% elif valuation.calculated_irr >= 0 %}text-gray-900{% else %}text-red-600{% endif %}">
                    {% if valuation.calculated_irr %}{{ valuation.calculated_irr|floatformat:1 }}%{% else %}-{% endif %}
                </p>
            </div>

            <!-- Current Price -->
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Price</p>
                <p class="mt-1 text-2xl font-semibold text-gray-900">
                    {% if valuation.effective_price %}${{ valuation.effective_price|floatformat:2 }}{% else %}-{% endif %}
                </p>
                {% if valuation.price_override %}
                <p class="text-xs text-amber-600">Manual override</p>
                {% endif %}
            </div>

            <!-- Terminal Value -->
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Terminal Value</p>
                <p class="mt-1 text-2xl font-semibold text-gray-900">
                    ${{ valuation.terminal_value|floatformat:2 }}
                </p>
            </div>

            <!-- As of Date -->
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">As of</p>
                <p class="mt-1 text-lg text-gray-900">
                    {{ valuation.as_of_date|date:"M d, Y" }}
                </p>
            </div>
        </div>

        <!-- FCF Forecasts -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-3">FCF Per Share Forecasts</p>
            <div class="grid grid-cols-5 gap-4 text-center">
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Year 1</p>
                    <p class="text-sm font-medium">${{ valuation.fcf_year_1|floatformat:2 }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Year 2</p>
                    <p class="text-sm font-medium">${{ valuation.fcf_year_2|floatformat:2 }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Year 3</p>
                    <p class="text-sm font-medium">${{ valuation.fcf_year_3|floatformat:2 }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Year 4</p>
                    <p class="text-sm font-medium">${{ valuation.fcf_year_4|floatformat:2 }}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="text-xs text-gray-500">Year 5</p>
                    <p class="text-sm font-medium">${{ valuation.fcf_year_5|floatformat:2 }}</p>
                </div>
            </div>
        </div>

        {% if valuation.notes %}
        <div class="mt-6 pt-6 border-t border-gray-200">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Notes</p>
            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ valuation.notes }}</p>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-6">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">No valuation yet</h3>
            <p class="mt-1 text-sm text-gray-500">Add a valuation to calculate IRR.</p>
            <div class="mt-4">
                <a href="{% url 'companies:valuation_create' company.slug %}"
                   class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                    <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                    </svg>
                    Add Valuation
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    {% endwith %}

    <!-- Notes -->
    <div class="bg-white shadow rounded-lg">
        <div class="border-b border-gray-200 px-4 py-5 sm:px-6 flex items-center justify-between">
            <h3 class="text-base font-semibold leading-6 text-gray-900">
                Research Notes
            </h3>
            <a href="{% url 'notes:create' %}?company={{ company.slug }}"
               class="text-sm font-medium text-primary-600 hover:text-primary-500">
                Add note
            </a>
        </div>
        <div class="divide-y divide-gray-200">
            {% for note in notes %}
            {% include "notes/partials/note_card.html" with note=note show_company=False %}
            {% empty %}
            <div class="px-4 py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-sm font-semibold text-gray-900">No notes yet</h3>
                <p class="mt-1 text-sm text-gray-500">Start documenting your research.</p>
                <div class="mt-6">
                    <a href="{% url 'notes:create' %}?company={{ company.slug }}"
                       class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        Add Note
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
